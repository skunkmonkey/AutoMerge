<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:AutoMerge.Core.Models;assembly=AutoMerge.Core"
             xmlns:converters="clr-namespace:AutoMerge.UI.Converters"
             xmlns:localization="clr-namespace:AutoMerge.UI.Localization"
             x:Class="AutoMerge.UI.Views.Panels.AiChatPanelView">
  
  <UserControl.Resources>
    <converters:ChatRoleToAlignmentConverter x:Key="ChatRoleToAlignmentConverter" />
    <converters:ChatRoleToBackgroundConverter x:Key="ChatRoleToBackgroundConverter" />
    <converters:ChatRoleToIconConverter x:Key="ChatRoleToIconConverter" />
  </UserControl.Resources>
  
  <Border Background="{StaticResource SurfaceBrush}"
          BorderBrush="{StaticResource BorderSubtleBrush}"
          BorderThickness="1"
          CornerRadius="8">
    <Grid RowDefinitions="Auto,*,Auto">
      
      <!-- Panel Header -->
      <Border Grid.Row="0"
              Background="{StaticResource SurfaceElevatedBrush}"
              CornerRadius="8,8,0,0"
              Padding="12,10">
        <Grid ColumnDefinitions="Auto,*,Auto">
          
          <!-- Icon + Title -->
          <StackPanel Orientation="Horizontal" Spacing="10" Grid.Column="0">
            <TextBlock Text="ðŸ¤–" FontSize="14" VerticalAlignment="Center" />
            <StackPanel Spacing="2">
              <TextBlock Text="{x:Static localization:UIStrings.AiChatPanelTitle}"
                         Foreground="{StaticResource TextPrimaryBrush}"
                         FontWeight="SemiBold"
                         FontSize="14" />
              <TextBlock Text="{x:Static localization:UIStrings.AiChatPanelSubtitle}"
                         Foreground="{StaticResource TextSecondaryBrush}"
                         FontSize="11"
                         Opacity="0.8" />
            </StackPanel>
          </StackPanel>
          
          <!-- Clear History Button -->
          <Button Grid.Column="2"
                  Theme="{StaticResource SubtleButton}"
              Content="{x:Static localization:UIStrings.AiChatPanelClearButton}"
                  Command="{Binding ClearHistoryCommand}"
              ToolTip.Tip="{x:Static localization:UIStrings.AiChatPanelClearHistoryTooltip}"
                  Padding="10,6"
                  FontSize="12" />
        </Grid>
      </Border>
      
      <!-- Messages Area -->
      <Border Grid.Row="1" 
              Background="{StaticResource AppBackgroundBrush}"
              Padding="12">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Spacing="12">
            
            <!-- Empty state placeholder (shown when no messages) -->
            
            <!-- Chat Messages -->
            <ItemsControl ItemsSource="{Binding Messages}">
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                  <Border Margin="0,4"
                          Background="{Binding Role, Converter={StaticResource ChatRoleToBackgroundConverter}}"
                          CornerRadius="8"
                          Padding="12"
                          HorizontalAlignment="{Binding Role, Converter={StaticResource ChatRoleToAlignmentConverter}}"
                          MaxWidth="500">
                    <StackPanel Spacing="6">
                      <!-- Role indicator -->
                      <StackPanel Orientation="Horizontal" Spacing="6">
                        <TextBlock Text="{Binding Role, Converter={StaticResource ChatRoleToIconConverter}}"
                                   FontSize="11" />
                        <TextBlock Foreground="{StaticResource TextTertiaryBrush}"
                                   FontSize="11"
                                   FontWeight="Medium">
                          <TextBlock.Text>
                            <MultiBinding StringFormat="{}{0}">
                              <Binding Path="Role" />
                            </MultiBinding>
                          </TextBlock.Text>
                        </TextBlock>
                      </StackPanel>
                      <!-- Message content -->
                      <TextBlock Text="{Binding Content}" 
                                 Foreground="{StaticResource TextPrimaryBrush}"
                                 FontSize="13"
                                 TextWrapping="Wrap" />
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
            
            <!-- Streaming Response Indicator -->
            <Border IsVisible="{Binding IsAiResponding}"
                    Background="{StaticResource SurfaceElevatedBrush}"
                    CornerRadius="8"
                    Padding="12"
                    HorizontalAlignment="Left"
                    MaxWidth="500">
              <StackPanel Spacing="6">
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="ðŸ¤–" FontSize="11" />
                  <TextBlock Text="{x:Static localization:UIStrings.AiChatPanelAssistantLabel}"
                             Foreground="{StaticResource TextTertiaryBrush}"
                             FontSize="11"
                             FontWeight="Medium" />
                  <TextBlock Text="{x:Static localization:UIStrings.AiChatPanelTypingLabel}"
                             Foreground="{StaticResource AccentBrush}"
                             FontSize="11"
                             FontStyle="Italic" />
                </StackPanel>
                <TextBlock Text="{Binding StreamingText}" 
                           Foreground="{StaticResource TextSecondaryBrush}"
                           FontSize="13"
                           TextWrapping="Wrap" />
              </StackPanel>
            </Border>
          </StackPanel>
        </ScrollViewer>
      </Border>
      
      <!-- Input Area -->
      <Border Grid.Row="2"
              Background="{StaticResource SurfaceElevatedBrush}"
              CornerRadius="0,0,8,8"
              Padding="12">
        <Grid ColumnDefinitions="*,Auto">
          <TextBox Grid.Column="0"
                   Text="{Binding CurrentInput, Mode=TwoWay}"
                   Watermark="{x:Static localization:UIStrings.AiChatPanelInputWatermark}"
                   Theme="{StaticResource ModernTextBox}"
                   AcceptsReturn="False" />
          
          <Button Grid.Column="1"
                  Theme="{StaticResource PrimaryButton}"
              Content="{x:Static localization:UIStrings.AiChatPanelSendButton}"
                  Command="{Binding SendMessageCommand}"
                  Margin="8,0,0,0"
                  Padding="20,10"
                  IsEnabled="{Binding SendMessageCommand.CanExecute}" />
        </Grid>
      </Border>
    </Grid>
  </Border>
</UserControl>
